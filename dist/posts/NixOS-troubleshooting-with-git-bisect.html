<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NixOS troubleshooting with git bisect</title>
    <meta name="description" content="">
    <meta name="author" content="Hrishikesh Barman">

    <link href="/assets/main.css" rel="stylesheet">

  <script>
  window.blogInfo = {
          pageType: 'post',
          postId: 17,
          comment: {"disabled":false,"isGithub":true,"isDisqus":false,"isGithubAuth":false,"disqus_id":"geekodour"},
          disqus_id: ""
  };
  </script>

  </head>

  <body>
<nav class="nav">
  <div class="nav-left"></div>
  <div class="nav-center">
  <a class="nav-item title is-5" href="/">
    geekodour's blog
  </a>
  </div>
  <span id="nav-toggle" class="nav-toggle">
  <span></span>
  <span></span>
  <span></span>
  </span>
  <div id="nav-menu" class="nav-right nav-menu">
  <a class="nav-item" href="">projects</a>
  <a class="nav-item" href="">favorites</a>
  <a class="nav-item" href="">contact</a>
  </div>
</nav>

  <div class="columns">
          <div class="column">
            <div class=""></div>
          </div>
          <div class="column is-half">
<div class="section">
  <div class="container">
    <div class="content">
      <div class="post-header">
      <span class="is-pulled-right">12/3/2017</span>
      </div>
      <h1>Nixos troubleshooting with git bisect</h1>
      <p>NixOS is an amazing Linux distribution. The <a href="https://www.infoq.com/articles/configuration-management-with-nix">InfoQ article</a> and <a href="https://nixos.org/~eelco/pubs/phd-thesis.pdf">thesis</a> are well worth your time to read. Meanwhile, here is a new trick I discovered for debugging Linux distribution upgrades using <a href="https://lwn.net/Articles/317154/"><code>git bisect</code></a>.</p>
<p>I upgraded from NixOS 15.07 to 17.03 and found that the <a href="https://github.com/NixOS/nixpkgs/issues/24541">Pharo Virtual Machine had broken</a>. Starting the VM would cause a Segmentation Fault within around one second. There was no obvious cause in the Pharo VM code itself: it seemed to be indirectly caused by a change in some dependency. There had been around 35,000 package updates to NixOS between those two releases, so how do you know which one is the problem?</p>
<p>It turns out that you can use <code>git bisect</code> to answer that question automatically. This is because the whole NixOS distribution is defined in a Git repository (<a href="https://github.com/nixos/nixpkgs/"><code>nixpkgs</code></a>) and so the history of every update to every package is tracked. So all I needed to do is write a script that starts the Pharo VM and checks whether it prints <code>Segmentation fault</code> within the first few seconds of execution. Easy, here it is:</p>
<pre><code class="lang-sh">#!/usr/bin/env bash
nix-env -j 10 -f . -iA pkgs.pharo-launcher || exit 125
timeout --preserve-status 20 pharo-launcher | grep &#39;(Segmentation fault)&#39;
status=$?
if [ &quot;$status&quot; == 0 ]; then
    echo &quot;SEGFAULT&quot;
    exit 1
else
    echo &quot;OK&quot;
    exit 0
fi
</code></pre>
<p>Then once I have this script I can ask <code>git bisect</code> to please find the commit that introduces the segmentation fault, considering all updates to all packages in the whole NixOS universe:</p>
<pre><code class="lang-shell">git bisect start master 15.09
git bisect run ./pharo-nix-bisect.sh
</code></pre>
<p>Finding the bad commit from a set of 35,000 actually only requires around 15 tests because <code>git bisect</code> uses a logarithmic-time binary search.</p>
<h3 id="result">Result</h3>
<p>This test ran for a few hours, testing many different versions of the whole OS including compiler toolchains, etc, and then finally pointed me in the right direction. It turns out that the problem was introduced by adding &quot;hardening&quot; to the default <code>CFLAGS</code> on NixOS and particularly by building Pharo with <code>-fPIC</code> which is not compatible with the VM. So I disabled <code>-fPIC</code> for the Pharo package on my <code>nixpkgs</code> branch, sent a <a href="https://github.com/NixOS/nixpkgs/pull/24595">pull request</a> upstream, and went on with my day.</p>
<p>Truly, this feels like a small step towards &quot;dependency heaven.&quot; Thanks, Nix!</p>

    </div>
  </div>
</div>
<div >
    <div class="section has-text-centered is-fluid">
      <button id="signin_button" class="button is-medium is-info">Go to Issue</button>
    </div>
  <div id="comments_container"></div>
  <div id="loadmore_container" class="has-text-centered"></div>
</div>
          </div>
          <div class="column">
            <div class="hidden-mobile">
<div class="card">
  <div class="card-content">
    <div class="media">
      <div class="media-left">
        <figure class="image is-48x48">
          <img src="http://bulma.io/images/placeholders/96x96.png" alt="Image">
        </figure>
      </div>
      <div class="media-content">
        <p class="title is-4">Hrishikesh Barman</p>
        <p class="subtitle is-6">@geekodour</p>
      </div>
    </div>

    <div class="content">
      <small>I am Hrishikesh</small>
    </div>
  </div>
</div>
<div class="card">
  <div class="card-content">
    <div class="content">
      <small>categories</small>
      <ul>
      <li><a href="/category/hacking">hacking</a></li>
      <li><a href="/category/life">life</a></li>
      <li><a href="/category/luajit">luajit</a></li>
      <li><a href="/category/snabb">snabb</a></li>
      <li><a href="/category/tech">tech</a></li>
      </ul>
    </div>
  </div>
</div>
            </div>
          </div>
  </div>
<footer class="footer">
  <div class="container">
    <div class="content has-text-centered">
      <p>github is love, github is life</p>
    </div>
  </div>
</footer>

      <script src="/assets/prism.js"></script>
      <script src="/assets/main.js"></script>
  </body>
</html>
